<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Preventive and Social Medicine</title>

  <style>
    :root{
      --bg:#07121f;
      --panel:#0c1c2e;
      --panel2:#0a1626;
      --text:#e7f0ff;
      --muted:#9fb2cc;
      --stroke:rgba(255,255,255,.08);
      --accent:#3ddc97;
      --accent2:#53b7ff;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 16px;
      --focus: 0 0 0 3px rgba(83,183,255,.25);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(61,220,151,.12), transparent 60%),
        radial-gradient(900px 500px at 80% 10%, rgba(83,183,255,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow:hidden;
    }
    button,input,textarea{font:inherit}
    a{color:inherit}
    .app{height:100%;display:grid;grid-template-rows:auto 1fr;}

    header{
      position:sticky;top:0;z-index:20;
      background: rgba(7,18,31,.75);
      backdrop-filter: blur(12px);
      border-bottom:1px solid var(--stroke);
    }
    .topbar{
      display:flex;align-items:center;gap:12px;
      padding:12px 14px;
      width:100%;max-width:none;margin:0;
    }
    .brand{display:flex;align-items:center;gap:10px;min-width:260px;}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(61,220,151,.35), rgba(83,183,255,.25));
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      display:grid;place-items:center;
    }
    .brand h1{font-size:15px;margin:0;line-height:1.1;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .spacer{flex:1}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      color:var(--muted);font-size:12px;white-space:nowrap;
    }
    .btn{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:9px 12px;border-radius:999px;
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(255,255,255,.09)}
    .btn:active{transform: translateY(1px)}
    .btn:focus{outline:none; box-shadow: var(--focus)}
    .btn.primary{background: rgba(61,220,151,.16); border-color: rgba(61,220,151,.35)}
    .btn.primary:hover{background: rgba(61,220,151,.22)}
    .btn.blue{background: rgba(83,183,255,.14); border-color: rgba(83,183,255,.35)}
    .btn.warn{background: rgba(255,204,102,.14); border-color: rgba(255,204,102,.35)}
    .btn.danger{background: rgba(255,107,107,.12); border-color: rgba(255,107,107,.35)}
    .btn.ghost{background: transparent}
    .btn.small{padding:7px 10px; font-size:12px}

    .shell{
      width:100%;max-width:none;margin:0;
      height:100%;min-height:0;
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:12px;
      padding:12px;
    }

    aside, main{
      border:1px solid var(--stroke);
      background: rgba(12,28,46,.72);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-height:0;
    }
    aside{overflow:hidden;display:flex;flex-direction:column;}
    .asideHead{
      padding:14px;border-bottom:1px solid var(--stroke);
      background: rgba(10,22,38,.6);
    }
    .asideHead .titleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .asideHead .byline{color:var(--muted);font-size:12px;margin-top:4px;}
    .searchRow{margin-top:12px;display:flex;gap:10px;}
    .searchRow input{
      width:100%;padding:10px 12px;border-radius:12px;
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      color:var(--text);
      outline:none;
    }
    .searchRow input:focus{box-shadow: var(--focus)}
    .topicList{padding:10px;overflow:auto;display:flex;flex-direction:column;gap:8px;}
    .topicItem{
      display:flex;align-items:center;gap:10px;
      padding:12px;border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      cursor:pointer;user-select:none;
    }
    .topicItem:hover{background: rgba(255,255,255,.06)}
    .topicItem.active{
      border-color: rgba(83,183,255,.35);
      background: rgba(83,183,255,.10);
    }
    .tIcon{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      flex:0 0 auto;
    }
    .tTitle{font-size:13px;line-height:1.2;flex:1;}
    .tActions{display:flex;gap:6px;align-items:center;}
    .iconBtn{
      width:30px;height:30px;border-radius:10px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color:var(--text);
      cursor:pointer;
    }
    .iconBtn:hover{background: rgba(255,255,255,.09)}
    .iconBtn:focus{outline:none; box-shadow: var(--focus)}

    main{overflow:auto;padding:14px;}
    .toolbar{
      display:flex;flex-wrap:wrap;gap:10px;
      padding:10px;
      border:1px solid var(--stroke);
      background: rgba(10,22,38,.55);
      border-radius: 14px;
      align-items:center;
    }
    .toolbar .meta{margin-left:auto;display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end;}
    .pageTitle{margin:16px 6px 8px;font-size:26px;letter-spacing:.2px;}
    .hint{margin:0 6px 14px;color:var(--muted);font-size:13px;}
    .cardRow{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin:10px 0 14px;
    }
    .card{
      padding:12px;border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      min-height:74px;
    }
    .card .label{color:var(--muted);font-size:12px;margin-bottom:6px}
    .card .value{font-weight:600;font-size:14px}

    details{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      overflow:hidden;
      margin:10px 0;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px 12px;
      display:flex;
      align-items:center;
      gap:10px;
      user-select:none;
    }
    summary::-webkit-details-marker{display:none}
    .chev{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      border:1px solid var(--stroke);
      background: rgba(0,0,0,.18);
      flex:0 0 auto;
    }
    details[open] .chev{
      background: rgba(83,183,255,.12);
      border-color: rgba(83,183,255,.25);
    }
    .subTitle{font-weight:600; flex:1}
    .subActions{display:flex; gap:6px}
    .subBody{
      padding:12px;
      border-top:1px solid var(--stroke);
      color:var(--muted);
      font-size:13px;
    }
    .emptyNote{
      padding:10px 12px;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:12px;
      background: rgba(0,0,0,.12);
    }
    .detailEditor{
      width:100%;
      min-height:110px;
      resize:vertical;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
    }
    .detailEditor:focus{box-shadow: var(--focus)}
    .editorHint{color:var(--muted);font-size:12px;margin:8px 2px 0}

    /* Feedback modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(520px, 100%);
      border-radius: 18px;
      border:1px solid var(--stroke);
      background: rgba(12,28,46,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal header{
      position:unset;
      border-bottom:1px solid var(--stroke);
      background: rgba(10,22,38,.55);
    }
    .modal .head{
      padding:12px 14px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .modal .body{padding:14px}
    .modal label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    .modal input, .modal textarea{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
    }
    .modal textarea{min-height:110px; resize:vertical}

    /* Mobile */
    .mobileToggle{display:none}
    @media (max-width: 980px){
      .shell{grid-template-columns: 1fr}
      aside{
        position:fixed;
        inset:64px 12px 12px 12px;
        z-index:30;
        display:none;
      }
      aside.open{display:flex}
      .mobileToggle{display:inline-flex}
      .cardRow{grid-template-columns: 1fr}
    }
  </style>
</head>

<body>
<div class="app">
  <header>
    <div class="topbar">
      <button class="btn ghost mobileToggle" id="btnSidebar" aria-label="Toggle topics">‚ò∞ Topics</button>

      <div class="brand">
        <div class="logo" aria-hidden="true">üõ°Ô∏è</div>
        <div>
          <h1>PSM</h1>
          <div class="sub">Preventive and Social Medicine</div>
        </div>
      </div>

      <div class="spacer"></div>

      <span class="pill" id="modePill">Mode: Preview</span>

      <button class="btn" id="btnHome">Home</button>

      <!-- Admin-only tools -->
      <button class="btn" id="btnManage">Manage Topics</button>
      <button class="btn blue" id="btnExport">Export</button>
      <button class="btn blue" id="btnImport">Import</button>
      <button class="btn primary" id="btnSaveAll">Save All</button>

      <!-- Admin login + edit toggle -->
      <button class="btn blue" id="btnAdmin">Admin Login</button>
      <button class="btn warn" id="btnToggleMode">Edit</button>

      <button class="btn" id="btnFeedback">Feedback</button>
      <button class="btn danger" id="btnExit">Exit</button>

      <input type="file" id="importFile" accept="application/json" hidden />
    </div>
  </header>

  <div class="shell">
    <aside id="sidebar" aria-label="Topic list">
      <div class="asideHead">
        <div class="titleRow">
          <div>
            <div style="font-weight:700;letter-spacing:.2px;">Topics</div>
            <div class="byline">Educational headings (expandable)</div>
            <div class="byline" style="margin-top:6px;">
              Concept by <span style="color:var(--text); font-weight:600;">Khushee Khan</span>
            </div>
          </div>

          <button class="btn small primary" id="btnAddTopic">+ Add</button>
        </div>

        <div class="searchRow">
          <input id="search" type="search" placeholder="Search topics (e.g., HIV, first aid)" aria-label="Search topics" />
        </div>
      </div>

      <div class="topicList" id="topicList"></div>
    </aside>

    <main aria-label="Topic content">
      <div class="toolbar" role="region" aria-label="Editor toolbar">
        <button class="btn small primary" id="btnRenameTopic">Rename topic</button>
        <button class="btn small" id="btnAddSub">+ Add subsection</button>
        <button class="btn small danger" id="btnDeleteTopic">Delete topic</button>

        <div class="meta">
          <span class="pill" id="storagePill">Storage: local</span>
          <span class="pill" id="savePill">Last save: ‚Äî</span>
        </div>
      </div>

      <h2 class="pageTitle" id="mainTitle">Preventive and Social Medicine</h2>
      <p class="hint" id="mainHint">Select a topic to view subsections.</p>

      <div class="cardRow" aria-label="Quick tiles">
        <div class="card">
          <div class="label">Daily focus</div>
          <div class="value" id="tile1">Balanced choices</div>
        </div>
        <div class="card">
          <div class="label">Key habits</div>
          <div class="value" id="tile2">Hydration + sleep</div>
        </div>
        <div class="card">
          <div class="label">Safety</div>
          <div class="value" id="tile3">Hygiene & prevention</div>
        </div>
      </div>

      <div id="subsections"></div>
    </main>
  </div>
</div>

<!-- Feedback Modal -->
<div class="modalBackdrop" id="feedbackBackdrop" role="dialog" aria-modal="true" aria-label="Feedback form">
  <div class="modal">
    <header>
      <div class="head">
        <div style="font-weight:700">Feedback / Suggestions</div>
        <div class="spacer"></div>
        <button class="btn small" id="btnCloseFeedback">Close</button>
      </div>
    </header>
    <div class="body">
      <div style="color:var(--muted);font-size:13px;">
        This form stores feedback locally (no server).
      </div>
      <label for="fbName">Name (optional)</label>
      <input id="fbName" />
      <label for="fbContact">Contact (optional)</label>
      <input id="fbContact" placeholder="Email or phone" />
      <label for="fbMsg">Message</label>
      <textarea id="fbMsg" placeholder="Your suggestion..."></textarea>
      <div style="display:flex; gap:10px; margin-top:12px; justify-content:flex-end;">
        <button class="btn" id="btnClearFb">Clear</button>
        <button class="btn primary" id="btnSubmitFb">Submit</button>
      </div>
    </div>
  </div>
</div>

<script>
  /* =========================
     CONFIG (CHANGE PASSWORD)
     ========================= */
  const ADMIN_PASSWORD = "psm123"; // change this

  /* =========================
     STORAGE KEYS
     ========================= */
  const STORAGE_KEY = "psm_topics_v2";       // v2 because subsections now store details
  const SAVE_KEY = "psm_last_save_v2";
  const FEEDBACK_KEY = "psm_feedback_v1";
  const ADMIN_SESSION_KEY = "psm_admin_session_v1";

  const ICONS = {
    nutrition: "ü•ó",
    malnutrition: "‚öñÔ∏è",
    obgyn: "üßë‚Äç‚öïÔ∏è",
    environment: "üåç",
    waste: "üß™",
    mental: "üß†",
    family: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
    menstrual: "ü©∏",
    pcos: "üß¨",
    myths: "üí¨",
    communicable: "ü¶†",
    obesity: "üèÉ",
    bp: "üíì",
    hiv: "üß´",
    firstaid: "ü©π",
    substance: "üö´",
    waterair: "üí®"
  };

  /* ---------- SAFE UUID (works even when crypto.randomUUID is missing) ---------- */
  function safeUUID(){
    try{
      if (window.crypto && typeof crypto.randomUUID === "function") return crypto.randomUUID();
    }catch(e){}
    // fallback
    return "id-" + Date.now().toString(16) + "-" + Math.random().toString(16).slice(2);
  }

  /* ---------- DATA MODEL ----------
     topic = { id, icon, title, subsections:[ { title, detail } ] }
  ---------------------------------- */
  function makeSub(title, detail=""){
    return { title, detail };
  }

  const DEFAULT_DATA = [
    {
      id: safeUUID(),
      icon: "nutrition",
      title: "Nutrition by Age & Gender",
      subsections: [
        makeSub("Infants (0‚Äì12 months)"),
        makeSub("Children (1‚Äì9 years)"),
        makeSub("Adolescents"),
        makeSub("Adults"),
        makeSub("Elderly"),
        makeSub("Gender-specific nutritional needs"),
        makeSub("Balanced diet & micronutrients"),
        makeSub("Lifestyle recommendations")
      ]
    },
    {
      id: safeUUID(),
      icon: "malnutrition",
      title: "Malnutrition (Overnutrition & Undernutrition)",
      subsections: [
        makeSub("Undernutrition: causes"),
        makeSub("Undernutrition: signs"),
        makeSub("Undernutrition: prevention"),
        makeSub("Overnutrition: risks"),
        makeSub("Overnutrition: lifestyle factors"),
        makeSub("Overnutrition: prevention")
      ]
    },
    {
      id: safeUUID(),
      icon: "obgyn",
      title: "Obstetrics, Paediatrics, and Geriatrics",
      subsections: [
        makeSub("Maternal health"),
        makeSub("Antenatal care"),
        makeSub("Child growth & development"),
        makeSub("Healthy aging"),
        makeSub("Elderly care")
      ]
    },
    {
      id: safeUUID(),
      icon: "environment",
      title: "Environment and Health",
      subsections: [
        makeSub("Environmental risk factors"),
        makeSub("Climate change and health"),
        makeSub("Sanitation and hygiene")
      ]
    },
    {
      id: safeUUID(),
      icon: "waste",
      title: "Hospital Waste Management",
      subsections: [
        makeSub("Types of biomedical waste"),
        makeSub("Segregation (color coding)"),
        makeSub("Disposal methods"),
        makeSub("Safety and compliance")
      ]
    },
    {
      id: safeUUID(),
      icon: "mental",
      title: "Mental Health",
      subsections: [
        makeSub("Common mental health conditions"),
        makeSub("Stress management"),
        makeSub("Coping strategies"),
        makeSub("Reducing stigma"),
        makeSub("Seeking help")
      ]
    },
    {
      id: safeUUID(),
      icon: "family",
      title: "Family Planning",
      subsections: [
        makeSub("Temporary methods"),
        makeSub("Permanent methods"),
        makeSub("Benefits of family planning"),
        makeSub("Myths vs facts")
      ]
    },
    {
      id: safeUUID(),
      icon: "menstrual",
      title: "Perimenopause Care/Menstrual Hygiene",
      subsections: [
        makeSub("Menstrual health education"),
        makeSub("Hygiene practices"),
        makeSub("Addressing stigma and taboos")
      ]
    },
    {
      id: safeUUID(),
      icon: "pcos",
      title: "Misconceptions Related to PCOS/PCOD",
      subsections: [
        makeSub("Common myths"),
        makeSub("Scientific facts"),
        makeSub("Lifestyle management"),
        makeSub("Medical management")
      ]
    },
    {
      id: safeUUID(),
      icon: "myths",
      title: "Myths, Taboos, and Lack of Awareness (Realted to Health)",
      subsections: [
        makeSub("Cultural misconceptions"),
        makeSub("Impact on health-seeking behavior"),
        makeSub("Awareness strategies")
      ]
    },
    {
      id: safeUUID(),
      icon: "communicable",
      title: "Communicable Diseases",
      subsections: [
        makeSub("Modes of transmission"),
        makeSub("Prevention and control"),
        makeSub("Immunization awareness")
      ]
    },
    {
      id: safeUUID(),
      icon: "obesity",
      title: "Obesity",
      subsections: [
        makeSub("Causes"),
        makeSub("Health risks"),
        makeSub("Prevention"),
        makeSub("Management")
      ]
    },
    {
      id: safeUUID(),
      icon: "bp",
      title: "Hypertension",
      subsections: [
        makeSub("Risk factors"),
        makeSub("Prevention"),
        makeSub("Lifestyle modification")
      ]
    },
    {
      id: safeUUID(),
      icon: "hiv",
      title: "HIV/AIDS",
      subsections: [
        makeSub("Transmission"),
        makeSub("Prevention"),
        makeSub("Reducing stigma"),
        makeSub("Testing and treatment")
      ]
    },
    {
      id: safeUUID(),
      icon: "firstaid",
      title: "First Aid",
      subsections: [
        makeSub("Basic first-aid measures"),
        makeSub("Emergency response guidelines")
      ]
    },
    {
      id: safeUUID(),
      icon: "substance",
      title: "Drug or Substance Abuse",
      subsections: [
        makeSub("Types of substance abuse"),
        makeSub("Health consequences"),
        makeSub("Social consequences"),
        makeSub("Prevention"),
        makeSub("Rehabilitation")
      ]
    },
    {
      id: safeUUID(),
      icon: "waterair",
      title: "Water, Air, and Airborne Diseases",
      subsections: [
        makeSub("Water-borne diseases"),
        makeSub("Air pollution and respiratory health"),
        makeSub("Airborne infections and prevention")
      ]
    }
  ];

  let state = {
    mode: "preview",    // preview | edit
    isAdmin: false,
    topics: [],
    selectedId: null,
    filter: ""
  };

  const $ = (id) => document.getElementById(id);

  function nowStamp(){
    const d = new Date();
    return d.toLocaleString();
  }

  function canEdit(){
    return state.isAdmin && state.mode === "edit";
  }

  function normalizeImportedData(data){
    // supports older format where subsections were strings
    return data.map(t => ({
      id: t.id || safeUUID(),
      icon: t.icon || "nutrition",
      title: t.title || "Untitled topic",
      subsections: (t.subsections || []).map(s => {
        if(typeof s === "string") return makeSub(s, "");
        return makeSub(s.title || "Untitled subsection", s.detail || "");
      })
    }));
  }

  function loadAdminSession(){
    state.isAdmin = localStorage.getItem(ADMIN_SESSION_KEY) === "true";
  }

  function setAdmin(on){
    state.isAdmin = on;
    localStorage.setItem(ADMIN_SESSION_KEY, on ? "true" : "false");
    if(!on) state.mode = "preview";
    applyPermissionsUI();
    render();
  }

  function setMode(mode){
    state.mode = mode;
    applyPermissionsUI();
    render();
  }

  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      state.topics = normalizeImportedData(JSON.parse(raw));
    }else{
      state.topics = DEFAULT_DATA;
    }
    state.selectedId = state.topics[0]?.id || null;

    const last = localStorage.getItem(SAVE_KEY);
    $("savePill").textContent = "Last save: " + (last || "‚Äî");
  }

  function save(){
    if(!state.isAdmin) return;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.topics));
    localStorage.setItem(SAVE_KEY, nowStamp());
    $("savePill").textContent = "Last save: " + localStorage.getItem(SAVE_KEY);
  }

  function currentTopic(){
    return state.topics.find(t => t.id === state.selectedId) || null;
  }

  function applyPermissionsUI(){
    $("modePill").textContent = "Mode: " + (state.mode === "edit" ? "Edit" : "Preview");
    $("btnAdmin").textContent = state.isAdmin ? "Admin Logout" : "Admin Login";

    // admin-only top tools
    $("btnManage").style.display = state.isAdmin ? "inline-flex" : "none";
    $("btnImport").style.display = state.isAdmin ? "inline-flex" : "none";
    $("btnSaveAll").style.display = state.isAdmin ? "inline-flex" : "none";

    // edit toggle only when admin
    $("btnToggleMode").style.display = state.isAdmin ? "inline-flex" : "none";
    $("btnToggleMode").textContent = (state.mode === "edit") ? "Preview" : "Edit";

    // editor buttons only when admin+edit
    const showEditor = canEdit();
    $("btnAddTopic").style.display = showEditor ? "inline-flex" : "none";
    $("btnRenameTopic").style.display = showEditor ? "inline-flex" : "none";
    $("btnAddSub").style.display = showEditor ? "inline-flex" : "none";
    $("btnDeleteTopic").style.display = showEditor ? "inline-flex" : "none";
  }

  function render(){
    renderTopics();
    renderMain();
  }

  function renderTopics(){
    const list = $("topicList");
    list.innerHTML = "";

    const q = state.filter.trim().toLowerCase();
    const showActions = canEdit();

    const filtered = state.topics.filter(t => {
      if(!q) return true;
      if((t.title || "").toLowerCase().includes(q)) return true;
      return (t.subsections || []).some(s => (s.title || "").toLowerCase().includes(q));
    });

    filtered.forEach(t => {
      const item = document.createElement("div");
      item.className = "topicItem" + (t.id === state.selectedId ? " active" : "");
      item.tabIndex = 0;
      item.setAttribute("role","button");
      item.setAttribute("aria-label","Select topic: " + t.title);

      item.addEventListener("click", () => {
        state.selectedId = t.id;
        render();
        closeSidebarOnMobile();
      });
      item.addEventListener("keydown", (e) => {
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          state.selectedId = t.id;
          render();
          closeSidebarOnMobile();
        }
      });

      const icon = document.createElement("div");
      icon.className = "tIcon";
      icon.textContent = ICONS[t.icon] || "üìå";

      const title = document.createElement("div");
      title.className = "tTitle";
      title.textContent = t.title;

      const actions = document.createElement("div");
      actions.className = "tActions";
      actions.style.display = showActions ? "flex" : "none";

      const editBtn = document.createElement("button");
      editBtn.className = "iconBtn";
      editBtn.title = "Rename topic";
      editBtn.textContent = "‚úé";
      editBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        renameTopic(t.id);
      });

      const delBtn = document.createElement("button");
      delBtn.className = "iconBtn";
      delBtn.title = "Delete topic";
      delBtn.textContent = "üóë";
      delBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        deleteTopic(t.id);
      });

      actions.append(editBtn, delBtn);
      item.append(icon, title, actions);
      list.appendChild(item);
    });

    if(filtered.length === 0){
      const empty = document.createElement("div");
      empty.style.padding = "12px";
      empty.style.color = "var(--muted)";
      empty.textContent = "No topics match your search.";
      list.appendChild(empty);
    }
  }

  function renderMain(){
    const topic = currentTopic();
    $("mainTitle").textContent = topic ? topic.title : "Preventive and Social Medicine";
    $("mainHint").textContent = topic
      ? (canEdit()
          ? "Admin ‚Üí Edit mode: you can add/rename/remove subsections and write details."
          : "View mode: expand any subsection to read details.")
      : "No topic found. Admin can add topics in Edit mode.";

    const container = $("subsections");
    container.innerHTML = "";
    if(!topic) return;

    const showActions = canEdit();

    (topic.subsections || []).forEach((sub, idx) => {
      const d = document.createElement("details");

      const s = document.createElement("summary");

      const chev = document.createElement("div");
      chev.className = "chev";
      chev.textContent = "‚åÑ";

      const title = document.createElement("div");
      title.className = "subTitle";
      title.textContent = sub.title || "Untitled subsection";

      const actions = document.createElement("div");
      actions.className = "subActions";
      actions.style.display = showActions ? "flex" : "none";

      const ren = document.createElement("button");
      ren.className = "iconBtn";
      ren.title = "Rename subsection";
      ren.textContent = "‚úé";
      ren.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        renameSub(idx);
      });

      const del = document.createElement("button");
      del.className = "iconBtn";
      del.title = "Delete subsection";
      del.textContent = "üóë";
      del.addEventListener("click", (e) => {
        e.preventDefault(); e.stopPropagation();
        deleteSub(idx);
      });

      actions.append(ren, del);
      s.append(chev, title, actions);

      const body = document.createElement("div");
      body.className = "subBody";

      if(showActions){
        const ta = document.createElement("textarea");
        ta.className = "detailEditor";
        ta.placeholder = "Write details here (Admin only).";
        ta.value = sub.detail || "";

        ta.addEventListener("input", () => {
          const t = currentTopic();
          if(!t) return;
          t.subsections[idx].detail = ta.value;
        });

        const hint = document.createElement("div");
        hint.className = "editorHint";
        hint.textContent = "Tip: Click ‚ÄúSave All‚Äù to store changes.";

        body.appendChild(ta);
        body.appendChild(hint);
      }else{
        const text = (sub.detail || "").trim();
        const box = document.createElement("div");
        box.className = "emptyNote";
        box.textContent = text ? text : "No details added yet.";
        body.appendChild(box);
      }

      d.append(s, body);
      container.appendChild(d);
    });

    if((topic.subsections || []).length === 0){
      const box = document.createElement("div");
      box.className = "emptyNote";
      box.style.marginTop = "12px";
      box.textContent = "No subsections yet. Admin can add using ‚Äú+ Add subsection‚Äù.";
      container.appendChild(box);
    }
  }

  /* ============ EDIT ACTIONS (ADMIN ONLY) ============ */
  function addTopic(){
    if(!canEdit()) return;
    const title = prompt("New topic title:");
    if(!title) return;

    state.topics.push({
      id: safeUUID(),
      icon: "nutrition",
      title: title.trim(),
      subsections: []
    });
    state.selectedId = state.topics[state.topics.length - 1].id;
    render();
  }

  function renameTopic(id){
    if(!canEdit()) return;
    const t = state.topics.find(x => x.id === id);
    if(!t) return;
    const next = prompt("Rename topic:", t.title);
    if(!next) return;
    t.title = next.trim();
    render();
  }

  function deleteTopic(id){
    if(!canEdit()) return;
    const t = state.topics.find(x => x.id === id);
    if(!t) return;
    if(!confirm(`Delete topic?\n\n${t.title}`)) return;

    const i = state.topics.findIndex(x => x.id === id);
    state.topics.splice(i, 1);

    if(state.selectedId === id){
      state.selectedId = state.topics[Math.max(0, i - 1)]?.id || state.topics[0]?.id || null;
    }
    render();
  }

  function addSub(){
    if(!canEdit()) return;
    const t = currentTopic();
    if(!t) return;
    const name = prompt("New subsection title:");
    if(!name) return;
    t.subsections.push(makeSub(name.trim(), ""));
    render();
  }

  function renameSub(idx){
    if(!canEdit()) return;
    const t = currentTopic();
    if(!t) return;
    const cur = t.subsections[idx]?.title || "";
    const next = prompt("Rename subsection:", cur);
    if(!next) return;
    t.subsections[idx].title = next.trim();
    render();
  }

  function deleteSub(idx){
    if(!canEdit()) return;
    const t = currentTopic();
    if(!t) return;
    const cur = t.subsections[idx]?.title || "";
    if(!confirm(`Delete subsection?\n\n${cur}`)) return;
    t.subsections.splice(idx, 1);
    render();
  }

  /* ============ EXPORT / IMPORT ============ */
  function exportJSON(){
    // export allowed for everyone (can lock it if needed)
    const blob = new Blob([JSON.stringify(state.topics, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "psm-topics.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  function importJSON(file){
    if(!state.isAdmin) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = normalizeImportedData(JSON.parse(reader.result));
        state.topics = data;
        state.selectedId = state.topics[0]?.id || null;
        render();
      }catch(e){
        alert("Import failed: invalid JSON format.");
      }
    };
    reader.readAsText(file);
  }

  /* ============ FEEDBACK ============ */
  function openFeedback(open){
    $("feedbackBackdrop").style.display = open ? "flex" : "none";
  }

  function submitFeedback(){
    const entry = {
      when: nowStamp(),
      name: $("fbName").value.trim(),
      contact: $("fbContact").value.trim(),
      message: $("fbMsg").value.trim()
    };
    if(!entry.message){
      alert("Please write a message.");
      return;
    }
    const arr = JSON.parse(localStorage.getItem(FEEDBACK_KEY) || "[]");
    arr.push(entry);
    localStorage.setItem(FEEDBACK_KEY, JSON.stringify(arr));
    $("fbMsg").value = "";
    alert("Saved locally. Thank you!");
    openFeedback(false);
  }

  /* ============ MOBILE SIDEBAR ============ */
  function closeSidebarOnMobile(){
    if(window.matchMedia("(max-width: 980px)").matches){
      $("sidebar").classList.remove("open");
    }
  }

  /* ============ WIRE UI ============ */
  $("search").addEventListener("input", (e) => {
    state.filter = e.target.value;
    renderTopics();
  });

  $("btnAddTopic").addEventListener("click", addTopic);
  $("btnRenameTopic").addEventListener("click", () => renameTopic(state.selectedId));
  $("btnAddSub").addEventListener("click", addSub);
  $("btnDeleteTopic").addEventListener("click", () => deleteTopic(state.selectedId));

  $("btnExport").addEventListener("click", exportJSON);

  $("btnImport").addEventListener("click", () => {
    if(!state.isAdmin) return;
    $("importFile").click();
  });
  $("importFile").addEventListener("change", (e) => {
    const f = e.target.files?.[0];
    if(f) importJSON(f);
    e.target.value = "";
  });

  $("btnSaveAll").addEventListener("click", save);

  // THIS IS THE FIX: toggles between Edit and Preview properly
  $("btnToggleMode").addEventListener("click", () => {
    if(!state.isAdmin) return;
    setMode(state.mode === "edit" ? "preview" : "edit");
  });

  $("btnAdmin").addEventListener("click", () => {
    if(state.isAdmin){
      if(confirm("Logout admin?")) setAdmin(false);
      return;
    }
    const pass = prompt("Enter admin password:");
    if(pass === ADMIN_PASSWORD){
      setAdmin(true);
      setMode("edit");
    }else if(pass !== null){
      alert("Wrong password.");
    }
  });

  $("btnFeedback").addEventListener("click", () => openFeedback(true));
  $("btnCloseFeedback").addEventListener("click", () => openFeedback(false));
  $("btnClearFb").addEventListener("click", () => {
    $("fbName").value = "";
    $("fbContact").value = "";
    $("fbMsg").value = "";
  });
  $("btnSubmitFb").addEventListener("click", submitFeedback);

  $("btnSidebar").addEventListener("click", () => {
    $("sidebar").classList.toggle("open");
  });

  $("btnHome").addEventListener("click", () => {
    state.selectedId = state.topics[0]?.id || null;
    render();
  });

  $("btnManage").addEventListener("click", () => {
    if(!state.isAdmin) return;
    alert("Admin tip:\n1) Use Edit mode to change titles and details.\n2) Click Save All to keep changes.\n3) Export/Import moves data between devices.");
  });

  $("btnExit").addEventListener("click", () => {
    // If you want ‚ÄúExit‚Äù to also force Preview mode:
    state.mode = "preview";
    applyPermissionsUI();
    alert("Exited to Preview. You can close the tab to exit the page.");
  });

  /* ============ INIT ============ */
  try{
    load();
    loadAdminSession();
    setMode(state.isAdmin ? "edit" : "preview");
    applyPermissionsUI();
    render();
  }catch(err){
    alert("Error loading page. Open DevTools Console to see details.");
    console.error(err);
  }
</script>
</body>
</html>


