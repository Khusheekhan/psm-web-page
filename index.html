<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Preventive and Social Medicine</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0a192f;
      --secondary:#64ffda;
      --accent:#00d4ff;
      --danger:#ff6b6b;
      --warn:#ffd166;
      --success:#06d6a0;
      --card:#112240;
      --text:#ccd6f6;
      --muted:#8892b0;
      --shadow:0 12px 40px rgba(0,0,0,.35);
      --transition:all .25s ease;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Roboto, sans-serif;
      color:var(--text);
      background:var(--primary);
      background-image:
        radial-gradient(circle at 10% 20%, rgba(100,255,218,.06) 0%, transparent 22%),
        radial-gradient(circle at 90% 80%, rgba(0,212,255,.05) 0%, transparent 22%);
      min-height:100vh;
    }

    .container{display:flex;min-height:100vh}

    /* Sidebar */
    .sidebar{
      width:300px;
      position:fixed; left:0; top:0;
      height:100vh;
      overflow-y:auto;
      padding:18px 0;
      background:rgba(10,25,47,.92);
      border-right:1px solid rgba(255,255,255,.08);
      backdrop-filter:blur(12px);
      z-index:1000;
      transition:var(--transition);
      pointer-events:auto;
    }
    .sidebar-header{padding:0 18px 16px;border-bottom:1px solid rgba(100,255,218,.2);margin-bottom:14px}
    .logo{
      display:flex;align-items:center;gap:10px;
      font-family:Poppins, sans-serif;
      font-weight:800;font-size:1.7rem;
      color:var(--secondary);
      text-shadow:0 0 10px rgba(100,255,218,.25);
    }
    .tagline{margin-left:34px;color:var(--muted);font-size:.9rem;font-weight:300}

    .edit-badge{
      display:none;
      margin:10px 18px 6px;
      padding:8px 12px;border-radius:18px;
      background:linear-gradient(45deg,#bc13fe,var(--accent));
      font-weight:800;font-size:.78rem;
      text-align:center;
      box-shadow:0 0 10px rgba(188,19,254,.35);
    }

    .search-box{padding:10px 18px}
    .search-box input{
      width:100%;
      padding:12px 16px;
      border-radius:28px;
      border:1px solid rgba(100,255,218,.3);
      background:rgba(17,34,64,.55);
      color:var(--text);
      outline:none;
      transition:var(--transition);
    }
    .search-box input:focus{border-color:var(--accent);box-shadow:0 0 14px rgba(0,212,255,.25)}

    .nav-menu{list-style:none;padding:0 10px}
    .nav-item{margin:6px 0;border-radius:12px;overflow:hidden}
    .nav-link{
      width:100%;
      display:flex;align-items:center;gap:12px;
      padding:13px 14px;
      border:0;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      text-align:left;
      border-radius:12px;
      transition:var(--transition);
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      pointer-events:auto;
    }
    .nav-link:hover{background:rgba(100,255,218,.11); color:var(--secondary); transform:translateX(3px)}
    .nav-link.active{
      background:rgba(100,255,218,.14);
      color:var(--secondary);
      border-left:4px solid var(--accent);
      box-shadow:0 0 20px rgba(0,212,255,.18);
    }
    .nav-link i{width:20px;text-align:center}
    .nav-title{flex:1}

    .topic-management{
      display:none;
      margin:12px 14px 10px;
      padding:14px;
      border-radius:14px;
      background:rgba(17,34,64,.86);
      border:1px solid rgba(100,255,218,.2);
    }
    .topic-management.active{display:block}
    .topic-management h4{
      font-family:Poppins, sans-serif;
      color:var(--accent);
      text-align:center;
      margin-bottom:10px;
    }
    .topic-form{display:flex;gap:10px;flex-wrap:wrap}
    .topic-form input,.topic-form select{
      flex:1;min-width:200px;
      padding:10px 12px;border-radius:10px;
      border:1px solid rgba(100,255,218,.28);
      background:rgba(10,25,47,.92);
      color:var(--text);
      outline:none;
    }
    .topic-form input:focus,.topic-form select:focus{border-color:var(--accent);box-shadow:0 0 10px rgba(0,212,255,.2)}
    .topic-form button{
      padding:10px 14px;border-radius:10px;border:0;
      font-weight:900;
      cursor:pointer;
      background:linear-gradient(45deg,var(--accent),#00ff9d);
      color:#001b2a;
      box-shadow:0 5px 18px rgba(0,212,255,.25);
    }

    .topic-list-edit{list-style:none;max-height:240px;overflow:auto;margin-top:10px}
    .topic-edit-item{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 12px;margin-bottom:8px;
      border-radius:12px;
      background:rgba(10,25,47,.55);
      border:1px solid rgba(100,255,218,.12);
    }
    .topic-edit-left{display:flex;align-items:center;gap:10px}
    .topic-actions{display:flex;gap:8px}
    .mini{
      border:0;border-radius:10px;
      padding:7px 10px;
      color:#fff;
      cursor:pointer;
      transition:var(--transition);
    }
    .mini:hover{transform:scale(1.05)}
    .mini.edit{background:linear-gradient(45deg,var(--accent),#2a9df4)}
    .mini.del{background:linear-gradient(45deg,var(--danger),#ff4757)}

    .sidebar-footer{
      padding:14px 18px 6px;
      border-top:1px solid rgba(100,255,218,.14);
      color:var(--muted);
      font-size:.82rem;
      margin-top:10px;
    }

    /* Main */
    .main{
      flex:1;
      margin-left:300px;
      padding:26px;
      min-height:100vh;
      position:relative;
      z-index:1;
    }

    .header{
      display:flex;justify-content:space-between;align-items:center;
      gap:12px;
      padding-bottom:14px;margin-bottom:18px;
      border-bottom:1px solid rgba(100,255,218,.18);
    }
    .left-head{display:flex;align-items:center;gap:10px}
    .title{
      font-family:Poppins, sans-serif;
      font-weight:800;font-size:2rem;
      color:var(--secondary);
      text-shadow:0 0 10px rgba(100,255,218,.2);
    }
    .menu-toggle{
      display:none;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(17,34,64,.85);
      color:var(--secondary);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-size:1.2rem;
    }

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:0;border-radius:12px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      transition:var(--transition);
    }
    .btn.primary{background:linear-gradient(45deg,var(--accent),#00ff9d);color:#001b2a}
    .btn.warn{background:linear-gradient(45deg,var(--warn),#ffb347);color:#001b2a}
    .btn.purple{background:linear-gradient(45deg,#bc13fe,#9d4edd);color:#fff}
    .btn.success{background:linear-gradient(45deg,#00ff9d,#00cc88);color:#001b2a}
    .btn.danger{background:linear-gradient(45deg,var(--danger),#ff4757);color:#fff}
    .btn:hover{transform:translateY(-2px); box-shadow:0 10px 25px rgba(0,0,0,.25)}

    .edit-controls{
      display:none;
      gap:10px;
      flex-wrap:wrap;
      padding:12px;
      border-radius:14px;
      margin-bottom:14px;
      background:rgba(17,34,64,.84);
      border:1px solid rgba(0,212,255,.22);
    }
    .edit-controls.active{display:flex}

    .card{
      background:linear-gradient(180deg, rgba(17,34,64,.95), rgba(17,34,64,.80));
      border:1px solid rgba(255,255,255,.08);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:520px;
      position:relative;
    }
    .card::before{
      content:"";
      position:absolute;left:0;top:0;right:0;height:4px;
      background:linear-gradient(90deg,var(--accent),#bc13fe);
    }
    .card-head{
      display:flex;justify-content:space-between;align-items:center;
      padding:18px;
      border-bottom:1px solid rgba(100,255,218,.16);
      gap:10px;
    }
    .card-head h2{
      font-family:Poppins, sans-serif;
      font-size:1.55rem;
      color:var(--secondary);
    }
    .content{padding:18px;line-height:1.85}
    .content img{
      max-width:100%;
      border-radius:12px;
      margin:10px 0;
      border:2px solid rgba(100,255,218,.2);
      cursor:pointer;
      transition:var(--transition);
    }
    .content img:hover{transform:scale(1.02);border-color:rgba(0,212,255,.55)}

    .editable{
      border:2px dashed rgba(0,212,255,.45);
      border-radius:14px;
      padding:14px;
      min-height:240px;
      background:rgba(10,25,47,.35);
      outline:none;
    }
    .editable:focus{border-color:rgba(0,212,255,.85);box-shadow:0 0 18px rgba(0,212,255,.15)}

    .empty{
      text-align:center;
      color:var(--muted);
      padding:30px 10px;
    }
    .empty i{font-size:3rem;color:var(--secondary);margin-bottom:10px}

    /* Modal */
    .modal{
      position:fixed;inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:center;justify-content:center;
      z-index:3000;
    }
    .modal .box{
      width:100%;max-width:420px;
      background:#102238;
      border:1px solid rgba(100,255,218,.22);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:18px;
    }
    .modal h3{font-family:Poppins, sans-serif;color:var(--secondary);margin-bottom:8px}
    .modal p{color:var(--muted);font-size:.92rem;margin-bottom:12px}
    .modal label{color:var(--muted);font-size:.9rem}
    .modal input{
      width:100%;
      margin-top:6px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(100,255,218,.25);
      background:rgba(10,25,47,.92);
      color:var(--text);
      outline:none;
    }
    .modal .row{display:flex;justify-content:flex-end;gap:10px;margin-top:14px}

    /* Toast */
    .toast{
      position:fixed;right:22px;bottom:22px;
      display:none;
      padding:12px 14px;
      border-radius:14px;
      font-weight:900;
      z-index:4000;
      box-shadow:0 0 10px var(--accent), 0 0 18px var(--accent);
      color:#001b2a;
      background:linear-gradient(45deg,var(--success),var(--accent));
      max-width:360px;
    }
    .toast.error{background:linear-gradient(45deg,var(--danger),#ff4757);color:#fff;box-shadow:0 0 12px rgba(255,107,107,.5)}
    .toast.warn{background:linear-gradient(45deg,var(--warn),#ffb347);color:#001b2a;box-shadow:0 0 12px rgba(255,209,102,.35)}

    /* Mobile */
    @media (max-width: 992px){
      .sidebar{width:280px; transform:translateX(-280px)}
      .sidebar.active{transform:translateX(0)}
      .main{margin-left:0}
      .menu-toggle{display:inline-flex}
      .header{flex-direction:column;align-items:flex-start}
      .actions{width:100%}
      .topic-form{flex-direction:column}
    }
  </style>
</head>

<body>
  <div class="container">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo"><i class="fas fa-heartbeat"></i><span>PS Medicine</span></div>
        <div class="tagline">Preventive & Social Medicine Education</div>
	<div class="subtagline">Concept by Khushee Khan</div>
      </div>

      <div class="edit-badge" id="editBadge"><i class="fas fa-edit"></i> EDIT MODE</div>

      <div class="search-box">
        <input id="searchInput" type="text" placeholder="Search topics..." />
      </div>

      <ul class="nav-menu" id="navMenu"></ul>

      <div class="topic-management" id="topicManagement">
        <h4><i class="fas fa-plus-circle"></i> Add / Manage Topics</h4>

        <div class="topic-form">
          <input id="newTopicName" type="text" placeholder="New topic name (press Enter)" />
          <select id="newTopicIcon">
            <option value="fas fa-apple-alt">üçé Nutrition</option>
            <option value="fas fa-balance-scale">‚öñÔ∏è Malnutrition</option>
            <option value="fas fa-tree">üå≥ Environment</option>
          </select>
          <button id="addTopicBtn"><i class="fas fa-plus"></i> Add Topic</button>
        </div>

        <ul class="topic-list-edit" id="topicListEdit"></ul>
      </div>

      <div class="sidebar-footer">
        <div>Last updated: <span id="lastUpdated">Never</span></div>
        <div>Total topics: <span id="topicCount">0</span></div>
      </div>
    </aside>

    <main class="main">
      <header class="header">
        <div class="left-head">
          <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
            <i class="fas fa-bars"></i>
          </button>
          <div class="title" id="pageTitle">Preventive and Social Medicine</div>
        </div>

        <div class="actions">
          <button class="btn primary" id="loginBtn"><i class="fas fa-lock"></i> Enter Edit Mode</button>
          <button class="btn success" id="saveAllBtn" style="display:none;"><i class="fas fa-save"></i> Save All</button>
          <button class="btn warn" id="previewBtn" style="display:none;"><i class="fas fa-eye"></i> Preview</button>
        </div>
      </header>

      <div class="edit-controls" id="editControls">
        <button class="btn success" id="saveBtn"><i class="fas fa-save"></i> Save</button>
        <button class="btn danger" id="cancelBtn"><i class="fas fa-times"></i> Cancel</button>
        <button class="btn primary" id="addSectionBtn"><i class="fas fa-plus"></i> Add Section</button>
        <button class="btn warn" id="deleteSectionBtn"><i class="fas fa-trash"></i> Delete Block</button>
        <button class="btn primary" id="insertImageBtn"><i class="fas fa-image"></i> Insert Image</button>
      </div>

      <section class="card">
        <div class="card-head">
          <h2 id="currentTopicTitle">Welcome</h2>
          <button class="btn purple" id="editTopicBtn" style="display:none;">
            <i class="fas fa-edit"></i> Edit Topic
          </button>
        </div>
        <div class="content" id="contentArea">
          <div class="empty">
            <i class="fas fa-book-medical"></i>
            <h3>Welcome</h3>
            <p>Select a topic from the sidebar.</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="box">
      <h3>Enter Edit Mode</h3>
      <p>Default password: <strong>admin123</strong></p>
      <label for="modalPassword">Password</label>
      <input id="modalPassword" type="password" placeholder="Enter password" />
      <div class="row">
        <button class="btn primary" id="modalLoginBtn">Login</button>
        <button class="btn danger" id="modalCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"><span id="toastMsg">Saved</span></div>

  <script>
    const STORAGE_CONTENT = "psmContent_v4";
    const STORAGE_AUTH = "psmAuth_v4";
    const STORAGE_LAST = "psmLastSaved_v4";

    const state = {
      currentTopic: null,
      editMode: false,
      isAuthenticated: false,
      topics: {}
    };

    // All topics have a blank <img src=""> slot
    const defaultTopics = {
      nutrition: {
        id: "nutrition",
        title: "Nutrition and Health",
        icon: "fas fa-apple-alt",
        content: `
          <h3>Nutrition and Health</h3>
          <p>Nutrition supports growth, immunity and development.</p>
          <ul>
            <li>Balanced diet</li>
            <li>Hydration</li>
            <li>Regular meals</li>
          </ul>
          <img src="https://images.unsplash.com/photo-1490818387583-1baba5e638af?q=80&w=1032&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Nutrition image">
        `
      },
      malnutrition: {
        id: "malnutrition",
        title: "Malnutrition",
        icon: "fas fa-balance-scale",
        content: `
          <h3>Malnutrition</h3>
          <p>Includes both undernutrition and overnutrition.</p>
          <img src="https://plus.unsplash.com/premium_photo-1661427350998-cfbf5e6f287f?q=80&w=1174&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Malnutrition image">
        `
      },
      environment: {
        id: "environment",
        title: "Environment and Health",
        icon: "fas fa-tree",
        content: `
          <h3>Environment and Health</h3>
          <p>Air, water and sanitation affect health outcomes.</p>
          <img src="https://plus.unsplash.com/premium_photo-1663100069438-06ac0c51a240?q=80&w=1172&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D" alt="Environment image">
        `
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      loadData();
      renderNav();
      bindEvents();
      updateUI();
      const first = Object.keys(state.topics)[0];
      if (first) selectTopic(first);
    });

    function bindEvents() {
      document.getElementById("menuToggle").addEventListener("click", () => {
        document.getElementById("sidebar").classList.toggle("active");
      });

      document.getElementById("searchInput").addEventListener("input", (e) => {
        const term = (e.target.value || "").toLowerCase().trim();
        document.querySelectorAll("#navMenu .nav-item").forEach(li => {
          const txt = li.textContent.toLowerCase();
          li.style.display = txt.includes(term) ? "" : "none";
        });
      });

      const navMenu = document.getElementById("navMenu");
      const onNavActivate = (e) => {
        const btn = e.target.closest("button.nav-link");
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        const id = btn.dataset.topicId;
        if (!id) return;
        selectTopic(id);
        if (window.innerWidth <= 992) {
          document.getElementById("sidebar").classList.remove("active");
        }
      };
      navMenu.addEventListener("pointerup", onNavActivate, { passive: false });
      navMenu.addEventListener("click", onNavActivate, { passive: false });

      document.getElementById("loginBtn").addEventListener("click", () => {
        if (state.isAuthenticated) logout();
        else openLoginModal();
      });

      document.getElementById("modalLoginBtn").addEventListener("click", () => {
        const pwd = document.getElementById("modalPassword").value;
        if (pwd === "admin123") {
          authenticate();
          closeLoginModal();
          document.getElementById("modalPassword").value = "";
        } else {
          toast("Wrong password", "error");
        }
      });

      document.getElementById("modalCancelBtn").addEventListener("click", closeLoginModal);
      document.getElementById("loginModal").addEventListener("click", (e) => {
        if (e.target.id === "loginModal") closeLoginModal();
      });

      document.getElementById("addTopicBtn").addEventListener("click", addTopic);
      document.getElementById("newTopicName").addEventListener("keydown", (e) => {
        if (e.key === "Enter") addTopic();
      });

      document.getElementById("editTopicBtn").addEventListener("click", toggleEditMode);

      document.getElementById("saveBtn").addEventListener("click", saveTopicEdits);
      document.getElementById("cancelBtn").addEventListener("click", cancelEdits);
      document.getElementById("addSectionBtn").addEventListener("click", addSection);
      document.getElementById("deleteSectionBtn").addEventListener("click", deleteSelectedBlock);
      document.getElementById("insertImageBtn").addEventListener("click", insertImage);

      document.getElementById("saveAllBtn").addEventListener("click", () => {
        saveAll();
        toast("All saved", "success");
      });

      document.getElementById("previewBtn").addEventListener("click", previewEdits);
    }

    function loadData() {
      const saved = localStorage.getItem(STORAGE_CONTENT);
      if (saved) {
        try { state.topics = JSON.parse(saved); }
        catch { state.topics = structuredClone(defaultTopics); }
      } else {
        state.topics = structuredClone(defaultTopics);
      }

      const auth = localStorage.getItem(STORAGE_AUTH);
      if (auth) {
        try {
          const a = JSON.parse(auth);
          if (a.isAuthenticated && a.expiry > Date.now()) state.isAuthenticated = true;
        } catch {}
      }

      const last = localStorage.getItem(STORAGE_LAST);
      document.getElementById("lastUpdated").textContent = last ? new Date(parseInt(last, 10)).toLocaleDateString() : "Never";
      document.getElementById("topicCount").textContent = Object.keys(state.topics).length;
    }

    function saveAll() {
      localStorage.setItem(STORAGE_CONTENT, JSON.stringify(state.topics));
      localStorage.setItem(STORAGE_LAST, String(Date.now()));
      document.getElementById("lastUpdated").textContent = new Date().toLocaleDateString();
      document.getElementById("topicCount").textContent = Object.keys(state.topics).length;
      renderNav();
      if (state.isAuthenticated) renderManageList();
    }

    function renderNav() {
      const nav = document.getElementById("navMenu");
      nav.innerHTML = "";
      const sorted = Object.values(state.topics).sort((a,b)=>a.title.localeCompare(b.title));
      for (const t of sorted) {
        const li = document.createElement("li");
        li.className = "nav-item";
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "nav-link";
        btn.dataset.topicId = t.id;
        btn.innerHTML = `<i class="${t.icon}"></i><span class="nav-title">${escapeHtml(t.title)}</span>`;
        li.appendChild(btn);
        nav.appendChild(li);
      }
      if (state.currentTopic) {
        const activeBtn = nav.querySelector(`button.nav-link[data-topic-id="${cssEscape(state.currentTopic)}"]`);
        if (activeBtn) activeBtn.classList.add("active");
      }
    }

    function selectTopic(id) {
      const topic = state.topics[id];
      if (!topic) return;
      state.editMode = false;
      document.getElementById("editControls").classList.remove("active");

      state.currentTopic = id;
      document.getElementById("pageTitle").textContent = topic.title;
      document.getElementById("currentTopicTitle").textContent = topic.title;

      const content = document.getElementById("contentArea");
      content.innerHTML = topic.content || "<p>No content.</p>";

      content.querySelectorAll("img").forEach(img => {
        img.addEventListener("click", () => {
          if (img.src) window.open(img.src, "_blank");
        });
      });

      document.querySelectorAll("#navMenu .nav-link").forEach(b => b.classList.remove("active"));
      const activeBtn = document.querySelector(`#navMenu .nav-link[data-topic-id="${cssEscape(id)}"]`);
      if (activeBtn) activeBtn.classList.add("active");

      updateUI();
    }

    function updateUI() {
      const loginBtn = document.getElementById("loginBtn");
      const editBtn = document.getElementById("editTopicBtn");
      const manage = document.getElementById("topicManagement");
      const badge = document.getElementById("editBadge");
      const saveAllBtn = document.getElementById("saveAllBtn");
      const previewBtn = document.getElementById("previewBtn");

      if (state.isAuthenticated) {
        loginBtn.className = "btn warn";
        loginBtn.innerHTML = `<i class="fas fa-lock-open"></i> Exit Edit Mode`;
        manage.classList.add("active");
        badge.style.display = "block";
        saveAllBtn.style.display = "inline-block";
        previewBtn.style.display = "inline-block";
        renderManageList();
      } else {
        loginBtn.className = "btn primary";
        loginBtn.innerHTML = `<i class="fas fa-lock"></i> Enter Edit Mode`;
        manage.classList.remove("active");
        badge.style.display = "none";
        saveAllBtn.style.display = "none";
        previewBtn.style.display = "none";
      }

      editBtn.style.display = (state.isAuthenticated && state.currentTopic && !state.editMode) ? "inline-block" : "none";
    }

    function openLoginModal() {
      document.getElementById("loginModal").style.display = "flex";
      setTimeout(()=>document.getElementById("modalPassword").focus(),0);
    }
    function closeLoginModal() { document.getElementById("loginModal").style.display = "none"; }

    function authenticate() {
      state.isAuthenticated = true;
      localStorage.setItem(STORAGE_AUTH, JSON.stringify({ isAuthenticated:true, expiry: Date.now() + 24*60*60*1000 }));
      updateUI();
      toast("Edit mode enabled", "success");
    }

    function logout() {
      state.isAuthenticated = false;
      state.editMode = false;
      localStorage.removeItem(STORAGE_AUTH);
      document.getElementById("editControls").classList.remove("active");
      updateUI();
      toast("Logged out", "warn");
      if (state.currentTopic) selectTopic(state.currentTopic);
    }

    function addTopic() {
      if (!state.isAuthenticated) { toast("Login to add topics", "error"); return; }
      const name = (document.getElementById("newTopicName").value || "").trim();
      const icon = document.getElementById("newTopicIcon").value;
      if (!name) { toast("Enter a topic name", "error"); return; }
      const id = slugify(name);
      if (state.topics[id]) { toast("Topic already exists", "error"); return; }
      state.topics[id] = {
        id,
        title: name,
        icon,
        content: `<h3>${escapeHtml(name)}</h3><p>Add content here...</p><img src="" alt="${escapeHtml(name)} image">`
      };
      document.getElementById("newTopicName").value = "";
      saveAll();
      selectTopic(id);
      toast(`Added: ${name}`, "success");
    }

    function renderManageList() {
      const list = document.getElementById("topicListEdit");
      list.innerHTML = "";
      const sorted = Object.values(state.topics).sort((a,b)=>a.title.localeCompare(b.title));
      for (const t of sorted) {
        const li = document.createElement("li");
        li.className = "topic-edit-item";
        li.innerHTML = `
          <div class="topic-edit-left">
            <i class="${t.icon}"></i>
            <span>${escapeHtml(t.title)}</span>
          </div>
          <div class="topic-actions">
            <button class="mini edit" type="button" title="Edit" data-id="${t.id}"><i class="fas fa-edit"></i></button>
            <button class="mini del" type="button" title="Delete" data-id="${t.id}"><i class="fas fa-trash"></i></button>
          </div>
        `;
        li.querySelector(".mini.edit").addEventListener("click", () => renameTopic(t.id));
        li.querySelector(".mini.del").addEventListener("click", () => deleteTopic(t.id));
        list.appendChild(li);
      }
    }

    function renameTopic(id) {
      const t = state.topics[id];
      if (!t) return;
      const newName = prompt("New topic name:", t.title);
      if (!newName || !newName.trim()) return;
      const newIcon = prompt("New icon class (example: fas fa-heart):", t.icon) || t.icon;
      t.title = newName.trim();
      t.icon = (newIcon || t.icon).trim();
      saveAll();
      if (state.currentTopic === id) selectTopic(id);
      toast("Topic updated", "success");
    }

    function deleteTopic(id) {
      const t = state.topics[id];
      if (!t) return;
      if (!confirm(`Delete "${t.title}"?`)) return;
      delete state.topics[id];
      saveAll();
      if (state.currentTopic === id) {
        const first = Object.keys(state.topics)[0];
        if (first) selectTopic(first);
        else {
          state.currentTopic = null;
          document.getElementById("pageTitle").textContent = "Preventive and Social Medicine";
          document.getElementById("currentTopicTitle").textContent = "Welcome";
          document.getElementById("contentArea").innerHTML = `
            <div class="empty"><i class="fas fa-folder-open"></i><h3>No topics</h3><p>Add topics in edit mode.</p></div>
          `;
        }
      }
      toast("Topic deleted", "warn");
    }

    function toggleEditMode() {
      if (!state.isAuthenticated) { openLoginModal(); return; }
      if (!state.currentTopic) return;
      state.editMode = !state.editMode;
      const controls = document.getElementById("editControls");
      const editBtn = document.getElementById("editTopicBtn");
      if (state.editMode) {
        controls.classList.add("active");
        editBtn.style.display = "none";
        makeEditable();
        toast("Editing enabled", "success");
      } else {
        controls.classList.remove("active");
        editBtn.style.display = "inline-block";
        selectTopic(state.currentTopic);
      }
    }

    function makeEditable() {
      const topic = state.topics[state.currentTopic];
      const contentArea = document.getElementById("contentArea");
      const ed = document.createElement("div");
      ed.id = "editableContent";
      ed.className = "editable";
      ed.contentEditable = "true";
      ed.innerHTML = topic.content || "<p>Start typing...</p><img src=\"\" alt=\"Image\">";
      contentArea.innerHTML = "";
      contentArea.appendChild(ed);
      ed.focus();
    }

    function saveTopicEdits() {
      if (!state.editMode || !state.currentTopic) return;
      const ed = document.getElementById("editableContent");
      if (!ed) return;
      state.topics[state.currentTopic].content = ed.innerHTML;
      saveAll();
      state.editMode = false;
      document.getElementById("editControls").classList.remove("active");
      toast("Saved", "success");
      selectTopic(state.currentTopic);
    }

    function cancelEdits() {
      state.editMode = false;
      document.getElementById("editControls").classList.remove("active");
      toast("Canceled", "warn");
      if (state.currentTopic) selectTopic(state.currentTopic);
    }

    function previewEdits() {
      if (!state.editMode) { toast("Enable edit mode to preview", "error"); return; }
      const ed = document.getElementById("editableContent");
      if (!ed) return;
      document.getElementById("contentArea").innerHTML = ed.innerHTML + `
        <div style="margin-top:12px;">
          <button class="btn primary" id="backToEditBtn"><i class="fas fa-edit"></i> Back to Editing</button>
        </div>`;
      document.getElementById("backToEditBtn").addEventListener("click", () => {
        makeEditable();
        document.getElementById("editControls").classList.add("active");
      });
      toast("Preview shown", "success");
    }

    function addSection() {
      if (!state.editMode) return;
      const ed = document.getElementById("editableContent");
      if (!ed) return;
      const block = document.createElement("div");
      block.innerHTML = "<h3>New Section</h3><p>Add content here...</p>";
      ed.appendChild(block);
      toast("Section added (save to keep)", "success");
    }

    function deleteSelectedBlock() {
      if (!state.editMode) return;
      const sel = window.getSelection();
      if (!sel || sel.rangeCount === 0) { toast("Select something first", "error"); return; }
      const range = sel.getRangeAt(0);
      const node = range.startContainer.nodeType === 1 ? range.startContainer : range.startContainer.parentElement;
      const ed = document.getElementById("editableContent");
      if (!ed || !node || !ed.contains(node) || node === ed) { toast("Click inside a block then try again", "error"); return; }
      if (confirm("Delete the selected element/block?")) {
        node.remove();
        toast("Deleted (save to keep)", "warn");
      }
    }

    // Modified: fill the first <img> in the editable area with the URL
    function insertImage() {
      if (!state.editMode) return;
      const url = prompt("Image URL:");
      if (!url) return;
      const alt = prompt("Caption / Alt text:", "Topic image") || "Topic image";
      const ed = document.getElementById("editableContent");
      if (!ed) return;

      const firstImg = ed.querySelector("img");
      if (firstImg) {
        firstImg.src = url;
        firstImg.alt = alt;
      } else {
        const img = document.createElement("img");
        img.src = url;
        img.alt = alt;
        ed.appendChild(img);
      }

      toast("Image set (save to keep)", "success");
    }

    function toast(msg, type) {
      const t = document.getElementById("toast");
      const m = document.getElementById("toastMsg");
      m.textContent = msg;
      t.className = "toast" + (type ? " " + type : "");
      t.style.display = "block";
      clearTimeout(toast._timer);
      toast._timer = setTimeout(()=>t.style.display="none", 2600);
    }

    function slugify(s){
      return String(s).toLowerCase().trim()
        .replace(/[\s_]+/g,"-")
        .replace(/[^a-z0-9-]/g,"")
        .replace(/-+/g,"-");
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","'");
    }

    function cssEscape(s){
      return String(s).replace(/"/g,'\\"');
    }
  </script>
</body>
</html>
