<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Preventive and Social Medicine</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#0a192f;
      --secondary:#64ffda;
      --accent:#00d4ff;
      --danger:#ff6b6b;
      --warn:#ffd166;
      --success:#06d6a0;

      --card:#112240;
      --text:#e6f0ff;
      --muted:#93a4c7;
      --shadow:0 14px 45px rgba(0,0,0,.38);
      --transition:all .25s ease;
      --border:1px solid rgba(255,255,255,.10);
      --ring:0 0 0 3px rgba(100,255,218,.15);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{
      font-family:Roboto, system-ui, -apple-system, Segoe UI, sans-serif;
      color:var(--text);
      background:var(--primary);
      background-image:
        radial-gradient(circle at 12% 18%, rgba(100,255,218,.08) 0%, transparent 24%),
        radial-gradient(circle at 88% 80%, rgba(0,212,255,.06) 0%, transparent 22%);
      min-height:100vh;
    }

    a{color:inherit}
    button, input, textarea{font-family:inherit}

    .container{display:flex;min-height:100vh}

    /* Sidebar */
    .sidebar{
      width:310px;
      position:fixed; left:0; top:0;
      height:100vh;
      overflow:auto;
      padding:18px 0 14px;
      background:rgba(10,25,47,.92);
      border-right:var(--border);
      backdrop-filter:blur(12px);
      z-index:1000;
      transition:var(--transition);
    }
    .sidebar-header{padding:0 18px 16px;border-bottom:1px solid rgba(100,255,218,.22);margin-bottom:12px}
    .logo{
      display:flex;align-items:center;gap:10px;
      font-family:Poppins, sans-serif;
      font-weight:800;font-size:1.55rem;
      color:var(--secondary);
      text-shadow:0 0 14px rgba(100,255,218,.18);
    }
    .logo i{font-size:1.2rem}
    .tagline{margin-left:34px;color:var(--muted);font-size:.92rem;font-weight:300;line-height:1.3}

    /* NEW: animated concept credit */
    .concept-credit{
      margin:10px 18px 0;
      padding:6px 10px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:0.9rem;
      color:var(--text);
      background:linear-gradient(120deg, rgba(100,255,218,.24), rgba(0,212,255,.18));
      box-shadow:0 0 12px rgba(100,255,218,.25);
      position:relative;
      overflow:hidden;
      animation:conceptGlow 4.5s ease-in-out infinite;
    }
    .concept-credit::before{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(120deg, rgba(255,255,255,.12), transparent, rgba(255,255,255,.04));
      transform:translateX(-130%);
      animation:conceptShine 6s ease-in-out infinite;
    }
    .concept-credit span{
      font-weight:700;
      letter-spacing:0.4px;
    }
    @keyframes conceptGlow{
      0%,100%{ box-shadow:0 0 10px rgba(100,255,218,.15); transform:translateY(0); }
      50%{ box-shadow:0 0 18px rgba(0,212,255,.35); transform:translateY(-1px); }
    }
    @keyframes conceptShine{
      0%{ transform:translateX(-130%); }
      60%{ transform:translateX(130%); }
      100%{ transform:translateX(130%); }
    }

    .search-wrap{padding:12px 18px 4px}
    .search{
      display:flex;align-items:center;gap:10px;
      background:rgba(17,34,64,.85);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
    }
    .search i{color:rgba(100,255,218,.85)}
    .search input{
      width:100%;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-size:.98rem;
    }
    .search input::placeholder{color:rgba(147,164,199,.75)}

    .nav{
      list-style:none;
      padding:6px 8px 10px;
    }
    .nav-item{margin:6px 10px}
    .nav-link{
      width:100%;
      display:flex;align-items:center;gap:12px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(17,34,64,.65);
      color:var(--text);
      text-decoration:none;
      cursor:pointer;
      transition:var(--transition);
      text-align:left;
    }
    .nav-link:hover{transform:translateY(-1px);border-color:rgba(100,255,218,.30)}
    .nav-link.active{border-color:rgba(100,255,218,.55); box-shadow:var(--ring)}
    .nav-link i{color:rgba(100,255,218,.95); width:18px}
    .nav-title{flex:1}
    .nav-actions{display:none; gap:8px}
    .nav-actions button{
      background:transparent;border:none;color:rgba(230,240,255,.9);
      cursor:pointer; padding:6px 8px; border-radius:10px;
    }
    .nav-actions button:hover{background:rgba(255,255,255,.08)}
    .sidebar.editing .nav-actions{display:flex}

    .sidebar-footer{
      padding:12px 18px 8px;
      border-top:1px solid rgba(255,255,255,.08);
      color:var(--muted);
      font-size:.92rem;
    }
    .small-note{font-size:.86rem;color:rgba(147,164,199,.85);margin-top:6px;line-height:1.35}

    /* Main */
    .main{
      margin-left:310px;
      width:calc(100% - 310px);
      min-height:100vh;
      padding:16px 18px 80px;
      transition:var(--transition);
    }
    .header{
      position:sticky; top:0;
      padding:12px 10px;
      background:rgba(10,25,47,.78);
      backdrop-filter:blur(12px);
      border:var(--border);
      border-radius:18px;
      z-index:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .left-head{display:flex;align-items:center;gap:12px}
    .menu-toggle{
      display:none;
      background:rgba(17,34,64,.9);
      border:var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .title{
      font-family:Poppins, sans-serif;
      font-weight:800;
      letter-spacing:.2px;
      font-size:1.15rem;
      color:var(--text);
    }
    .actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap}

    .btn{
      border:none;
      cursor:pointer;
      border-radius:14px;
      padding:10px 12px;
      display:flex; align-items:center; gap:8px;
      transition:var(--transition);
      font-weight:700;
      letter-spacing:.1px;
      color:#03121f;
      background:#dbe9ff;
    }
    .btn i{opacity:.9}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0px)}
    .btn.primary{background:linear-gradient(90deg, var(--secondary), var(--accent));}
    .btn.success{background:linear-gradient(90deg, var(--success), rgba(6,214,160,.7));}
    .btn.warn{background:linear-gradient(90deg, var(--warn), rgba(255,209,102,.7));}
    .btn.danger{background:linear-gradient(90deg, var(--danger), rgba(255,107,107,.75));}
    .btn.ghost{
      background:rgba(17,34,64,.75);
      color:var(--text);
      border:var(--border);
    }
    .btn.ghost:hover{border-color:rgba(100,255,218,.35)}

    .meta-bar{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      color:var(--muted);
      font-size:.92rem;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;
      background:rgba(17,34,64,.75);
      border:1px solid rgba(255,255,255,.08);
      border-radius:999px;
    }
    .pill b{color:var(--text)}
    .pill code{color:rgba(100,255,218,.95)}

    .edit-controls{
      margin-top:14px;
      padding:12px;
      border:var(--border);
      border-radius:18px;
      background:rgba(17,34,64,.55);
      display:none;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .edit-controls .btn{padding:10px 12px}
    .edit-controls .hint{margin-left:auto;color:var(--muted);font-size:.92rem}

    .content{
      margin-top:14px;
      border:var(--border);
      background:rgba(17,34,64,.55);
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow);
      min-height:62vh;
    }

    .empty{
      text-align:center;
      padding:46px 14px;
      color:var(--muted);
    }
    .empty i{font-size:2.4rem;color:rgba(100,255,218,.85);margin-bottom:12px}
    .empty h3{font-family:Poppins, sans-serif;color:var(--text);margin-bottom:6px}

    /* Topic content styling */
    .topic h2{
      font-family:Poppins, sans-serif;
      font-weight:800;
      font-size:1.55rem;
      margin-bottom:8px;
      color:var(--secondary);
    }
    .topic p{color:rgba(230,240,255,.92);line-height:1.6;margin:10px 0}
    .topic ul{margin:10px 0 10px 18px;line-height:1.6}
    .topic li{margin:5px 0;color:rgba(230,240,255,.92)}
    .topic img{
      width:100%;
      max-height:320px;
      object-fit:cover;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      margin-top:12px;
      background:rgba(10,25,47,.6);
    }
    .topic .callout{
      margin:12px 0;
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(100,255,218,.22);
      background:rgba(10,25,47,.5);
    }
    .topic .callout strong{color:var(--secondary)}
    .topic details{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      margin:10px 0;
      overflow:hidden;
      background:rgba(10,25,47,.35);
    }
    .topic summary{
      cursor:pointer;
      list-style:none;
      padding:12px 14px;
      font-weight:800;
      font-family:Poppins, sans-serif;
      color:rgba(230,240,255,.96);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .topic summary::-webkit-details-marker{display:none}
    .topic summary:after{
      content:"\f078";
      font-family:"Font Awesome 6 Free";
      font-weight:900;
      color:rgba(100,255,218,.9);
      transition:transform .2s ease;
    }
    .topic details[open] summary:after{transform:rotate(180deg)}
    .topic details .inside{padding:12px 14px;border-top:1px solid rgba(255,255,255,.08)}
    .topic .kpi{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:10px;
      margin:10px 0 2px;
    }
    .kpi .card{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:rgba(17,34,64,.65);
      padding:12px 12px;
    }
    .kpi .card .label{color:var(--muted);font-size:.9rem}
    .kpi .card .value{margin-top:6px;font-family:Poppins, sans-serif;font-weight:900}

    /* Editable */
    .editable[contenteditable="true"]{
      outline:none;
      border-radius:12px;
      box-shadow:var(--ring);
      background:rgba(0,0,0,.12);
      padding:10px;
    }
    .selected-block{
      outline:2px dashed rgba(255,209,102,.8);
      border-radius:14px;
    }

    /* Manage panel */
    .panel{
      position:fixed;
      right:18px;
      bottom:78px;
      width:min(420px, calc(100% - 36px));
      border:var(--border);
      border-radius:18px;
      background:rgba(10,25,47,.92);
      backdrop-filter:blur(12px);
      box-shadow:var(--shadow);
      padding:14px;
      display:none;
      z-index:1300;
    }
    .panel h3{
      font-family:Poppins, sans-serif;
      font-weight:900;
      margin-bottom:8px;
      color:var(--secondary);
    }
    .panel .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .panel input, .panel textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(17,34,64,.75);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    .panel input:focus, .panel textarea:focus{box-shadow:var(--ring); border-color:rgba(100,255,218,.35)}
    .panel label{display:block;margin-top:10px;color:var(--muted);font-size:.92rem}
    .panel .list{
      margin-top:10px;
      max-height:220px;
      overflow:auto;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      background:rgba(17,34,64,.55);
    }
    .panel .item{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.07);
    }
    .panel .item:last-child{border-bottom:none}
    .panel .item .name{flex:1}
    .panel .item .mini{
      border:none;background:transparent;color:var(--text);
      cursor:pointer;padding:6px 8px;border-radius:10px;
    }
    .panel .item .mini:hover{background:rgba(255,255,255,.08)}
    .panel .muted{color:var(--muted);font-size:.9rem;margin-top:8px;line-height:1.35}

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:16px;
    }
    .modal.show{display:flex}
    .modal .box{
      width:min(520px, 100%);
      background:rgba(10,25,47,.96);
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .modal h3{
      font-family:Poppins, sans-serif;
      font-weight:900;
      margin-bottom:10px;
      color:var(--secondary);
    }
    .modal p{color:var(--muted);line-height:1.5;margin-bottom:10px}
    .modal label{display:block;margin-top:10px;color:var(--muted);font-size:.92rem}
    .modal input, .modal textarea, .modal select{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(17,34,64,.75);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    .modal input:focus, .modal textarea:focus{box-shadow:var(--ring); border-color:rgba(100,255,218,.35)}
    .modal .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .modal .row .btn{flex:1;justify-content:center}

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(17,34,64,.95);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 14px;
      border-radius:999px;
      display:none;
      align-items:center;
      gap:10px;
      z-index:2500;
      box-shadow:var(--shadow);
      color:rgba(230,240,255,.95);
    }
    .toast.show{display:flex}
    .toast i{color:var(--secondary)}

    /* Floating feedback button */
    .fab{
      position:fixed;
      right:18px;
      bottom:18px;
      z-index:1800;
      border-radius:999px;
      padding:12px 14px;
      box-shadow:var(--shadow);
    }

    /* Responsive */
    @media (max-width: 980px){
      .menu-toggle{display:inline-flex}
      .sidebar{
        transform:translateX(-102%);
        width:min(320px, 84vw);
      }
      .sidebar.active{transform:translateX(0)}
      .main{
        margin-left:0;
        width:100%;
      }
      .kpi{grid-template-columns:1fr}
      .header{border-radius:16px}
    }
  </style>
</head>
<body>
  <div class="container">

    <aside class="sidebar" id="sidebar" aria-label="Topic navigation">
      <div class="sidebar-header">
        <div class="logo"><i class="fas fa-shield-heart"></i> PSM</div>
        <div class="tagline">
          Preventive and Social Medicine • Simple, evidence‑based health education
        </div>
        <div class="concept-credit">
          Concept by <span>Khushee Khan</span>
        </div>
      </div>

      <div class="search-wrap">
        <div class="search" role="search">
          <i class="fas fa-magnifying-glass"></i>
          <input id="searchInput" type="text" placeholder="Search topics (e.g., HIV, first aid)..." aria-label="Search topics">
        </div>
      </div>

      <ul class="nav" id="navMenu" aria-label="Topics list"></ul>

      <div class="sidebar-footer">
        <div class="pill"><i class="fas fa-layer-group"></i> Total topics: <b id="topicCount">0</b></div>
        <div class="small-note">
          Tip: Use “Enter Edit Mode” to update content on this device (saved in browser storage).
        </div>
      </div>
    </aside>

    <main class="main">
      <header class="header" role="banner">
        <div class="left-head">
          <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
            <i class="fas fa-bars"></i>
          </button>
          <div class="title" id="pageTitle">Preventive and Social Medicine</div>
        </div>

        <div class="actions" aria-label="Actions">
          <!-- NEW home button -->
          <button class="btn ghost" id="homeBtn"><i class="fas fa-house"></i> Home</button>

          <button class="btn primary" id="loginBtn"><i class="fas fa-lock"></i> Enter Edit Mode</button>
          <button class="btn ghost" id="manageBtn" style="display:none;"><i class="fas fa-screwdriver-wrench"></i> Manage Topics</button>
          <button class="btn ghost" id="exportBtn" style="display:none;"><i class="fas fa-file-export"></i> Export</button>
          <button class="btn ghost" id="importBtn" style="display:none;"><i class="fas fa-file-import"></i> Import</button>
          <button class="btn success" id="saveAllBtn" style="display:none;"><i class="fas fa-floppy-disk"></i> Save All</button>
          <button class="btn warn" id="previewBtn" style="display:none;"><i class="fas fa-eye"></i> Preview</button>
          <button class="btn danger" id="logoutBtn" style="display:none;"><i class="fas fa-right-from-bracket"></i> Exit</button>
        </div>
      </header>

      <div class="meta-bar" aria-label="Status">
        <div class="pill"><i class="fas fa-circle-info"></i> Mode: <b id="modePill">View</b></div>
        <div class="pill"><i class="fas fa-database"></i> Storage: <code id="storagePill">local</code></div>
        <div class="pill"><i class="fas fa-clock"></i> Last save: <b id="lastSavePill">—</b></div>
      </div>

      <div class="edit-controls" id="editControls" aria-label="Editor controls">
        <button class="btn success" id="saveBtn"><i class="fas fa-save"></i> Save Topic</button>
        <button class="btn danger" id="cancelBtn"><i class="fas fa-times"></i> Cancel</button>
        <button class="btn primary" id="addBlockBtn"><i class="fas fa-plus"></i> Add Block</button>
        <button class="btn warn" id="deleteBlockBtn"><i class="fas fa-trash"></i> Delete Selected Block</button>
        <button class="btn ghost" id="insertImageBtn"><i class="fas fa-image"></i> Insert Image</button>
        <div class="hint">Click a paragraph/section to select a block, then edit.</div>
      </div>

      <div class="content" id="contentArea" aria-live="polite">
        <div class="empty">
          <i class="fas fa-book-medical"></i>
          <h3>Welcome</h3>
          <p>Select a topic from the sidebar to start learning.</p>
        </div>
      </div>
    </main>

    <!-- Manage panel -->
    <div class="panel" id="managePanel" aria-label="Manage topics panel">
      <h3>Manage Topics</h3>

      <label for="newTopicTitle">Add new topic</label>
      <input id="newTopicTitle" type="text" placeholder="Topic title (e.g., Diabetes awareness)" />
      <label for="newTopicIcon">Icon (Font Awesome class)</label>
      <input id="newTopicIcon" type="text" placeholder="e.g., fas fa-heartbeat" />
      <div class="row">
        <button class="btn success" id="addTopicBtn"><i class="fas fa-plus"></i> Add Topic</button>
        <button class="btn ghost" id="closeManageBtn"><i class="fas fa-xmark"></i> Close</button>
      </div>

      <div class="muted">
        Rename or delete topics below. Deleting removes it from this device only.
      </div>

      <div class="list" id="manageList" aria-label="Topics list for management"></div>
    </div>

  </div>

  <!-- Login modal -->
  <div class="modal" id="loginModal" aria-hidden="true">
    <div class="box">
      <h3>Enter Edit Mode</h3>
      <p>Edit mode allows adding/removing topics and updating content (saved locally in your browser).</p>
      <p>Default password: <b>admin123</b> (change it in code if needed).</p>
      <label for="modalPassword">Password</label>
      <input id="modalPassword" type="password" placeholder="Enter password" />
      <div class="row">
        <button class="btn primary" id="modalLoginBtn"><i class="fas fa-key"></i> Login</button>
        <button class="btn danger" id="modalCancelBtn"><i class="fas fa-xmark"></i> Cancel</button>
      </div>
    </div>
  </div>

  <!-- Import modal -->
  <div class="modal" id="importModal" aria-hidden="true">
    <div class="box">
      <h3>Import Topics (JSON)</h3>
      <p>Paste exported JSON below to restore/update topics on this device.</p>
      <label for="importText">JSON</label>
      <textarea id="importText" rows="10" placeholder='{"topics":{...}}'></textarea>
      <div class="row">
        <button class="btn success" id="doImportBtn"><i class="fas fa-check"></i> Import</button>
        <button class="btn danger" id="closeImportBtn"><i class="fas fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>

  <!-- Export modal -->
  <div class="modal" id="exportModal" aria-hidden="true">
    <div class="box">
      <h3>Export Topics (JSON)</h3>
      <p>Copy this JSON and save it (or share with other educators).</p>
      <label for="exportText">JSON</label>
      <textarea id="exportText" rows="10" readonly></textarea>
      <div class="row">
        <button class="btn primary" id="copyExportBtn"><i class="fas fa-copy"></i> Copy</button>
        <button class="btn danger" id="closeExportBtn"><i class="fas fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>

  <!-- Insert image modal -->
  <div class="modal" id="imageModal" aria-hidden="true">
    <div class="box">
      <h3>Insert Image</h3>
      <p>Add an image URL (e.g., a poster, infographic, or free stock image link).</p>
      <label for="imgUrl">Image URL</label>
      <input id="imgUrl" type="text" placeholder="https://example.com/image.jpg" />
      <label for="imgAlt">Alt text (important for accessibility)</label>
      <input id="imgAlt" type="text" placeholder="Describe the image in 1 line" />
      <div class="row">
        <button class="btn success" id="insertImgBtn"><i class="fas fa-image"></i> Insert</button>
        <button class="btn danger" id="closeImgBtn"><i class="fas fa-xmark"></i> Close</button>
      </div>
    </div>
  </div>

  <!-- Feedback modal -->
  <button class="btn primary fab" id="feedbackOpenBtn" aria-label="Open feedback form">
    <i class="fas fa-comment-dots"></i> Feedback
  </button>
  <div class="modal" id="feedbackModal" aria-hidden="true">
    <div class="box">
      <h3>Feedback / Suggestion</h3>
      <p>Share a suggestion, report an error, or propose a new topic.</p>
      <label for="fbName">Name (optional)</label>
      <input id="fbName" type="text" placeholder="Your name (optional)" />
      <label for="fbRole">Audience</label>
      <select id="fbRole">
        <option value="general">General public</option>
        <option value="student">Student</option>
        <option value="health_worker">Health worker</option>
        <option value="educator">Educator</option>
      </select>
      <label for="fbText">Message</label>
      <textarea id="fbText" rows="6" placeholder="Write your feedback..."></textarea>
      <div class="row">
        <button class="btn success" id="fbSendBtn"><i class="fas fa-paper-plane"></i> Submit</button>
        <button class="btn danger" id="fbCloseBtn"><i class="fas fa-xmark"></i> Close</button>
      </div>
      <p class="small-note">This demo stores feedback on this device only (no server).</p>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast" role="status" aria-live="polite">
    <i class="fas fa-circle-check"></i>
    <span id="toastMsg">Saved</span>
  </div>

  <script>
    /***************
     * Storage keys
     ***************/
    const STORAGE_CONTENT = "psmContent_v5";
    const STORAGE_AUTH    = "psmAuth_v5";
    const STORAGE_LAST    = "psmLastSaved_v5";
    const STORAGE_FEEDBACK= "psmFeedback_v1";

    /***************
     * App state
     ***************/
    const state = {
      currentTopic: null,
      editMode: false,
      isAuthenticated: false,
      topics: {},
      draftHtml: null,
      selectedBlock: null
    };

    /***************
     * Default topics (with Home)
     ***************/
    const defaultTopics = {
      home: {
        id: "home",
        title: "Home / Overview",
        icon: "fas fa-house-medical",
        content: `
          <div class="topic">
            <h2>Preventive and Social Medicine</h2>
            <p>This tool gives simple, evidence-based health messages for teaching and self-learning.</p>
            <details open>
              <summary>How to use this app</summary>
              <div class="inside">
                <ul>
                  <li>Browse topics from the left sidebar (nutrition, environment, NCDs, HIV, first aid, and more).</li>
                  <li>Click each section heading to expand "Read more" details and bullet points.</li>
                  <li>Educators can enter Edit Mode to adapt content to local language or programs.</li>
                </ul>
              </div>
            </details>
            <details>
              <summary>Who is this for?</summary>
              <div class="inside">
                <ul>
                  <li>Students, health workers, and community volunteers preparing talks or sessions.</li>
                  <li>Anyone who wants a quick refresher on key public health messages.</li>
                </ul>
              </div>
            </details>
          </div>
        `
      },

      /* the rest of your topics from the original file go here unchanged;
         to keep the message short they are omitted, but you can paste
         everything from nutrition_age_gender to water_air_airborne exactly
         as in your existing code. */
      /* ---- START existing topics ---- */
      /* paste existing topic objects here */
      /* ---- END existing topics ---- */
    };

    /***************
     * Utility
     ***************/
    function toast(msg="Done"){
      const t = document.getElementById("toast");
      document.getElementById("toastMsg").textContent = msg;
      t.classList.add("show");
      window.clearTimeout(toast._timer);
      toast._timer = window.setTimeout(()=>t.classList.remove("show"), 2200);
    }

    function slugify(str){
      return (str || "")
        .toLowerCase()
        .trim()
        .replace(/['"]/g,"")
        .replace(/[^a-z0-9]+/g,"_")
        .replace(/^_+|_+$/g,"")
        .slice(0, 48) || ("topic_" + Math.random().toString(16).slice(2,8));
    }

    function escapeHtml(str){
      return (str || "").replace(/[&<>\"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    function updateLastSaved(ts){
      localStorage.setItem(STORAGE_LAST, String(ts));
      document.getElementById("lastSavePill").textContent = new Date(ts).toLocaleString();
    }

    function loadData(){
      const raw = localStorage.getItem(STORAGE_CONTENT);
      if(raw){
        try{
          const parsed = JSON.parse(raw);
          if(parsed && parsed.topics) state.topics = parsed.topics;
          else state.topics = {...defaultTopics};
        }catch(e){
          state.topics = {...defaultTopics};
        }
      } else {
        state.topics = {...defaultTopics};
      }

      const auth = localStorage.getItem(STORAGE_AUTH);
      state.isAuthenticated = auth === "1";
      state.editMode = state.isAuthenticated;

      const last = localStorage.getItem(STORAGE_LAST);
      if(last) document.getElementById("lastSavePill").textContent = new Date(Number(last)).toLocaleString();
    }

    function saveAll(){
      localStorage.setItem(STORAGE_CONTENT, JSON.stringify({ topics: state.topics }));
      updateLastSaved(Date.now());
      toast("Saved all topics");
    }

    function renderNav(){
      const nav = document.getElementById("navMenu");
      nav.innerHTML = "";

      const keys = Object.keys(state.topics);
      document.getElementById("topicCount").textContent = String(keys.length);

      keys.forEach(key=>{
        const t = state.topics[key];
        const li = document.createElement("li");
        li.className = "nav-item";

        const btn = document.createElement("button");
        btn.className = "nav-link";
        btn.type = "button";
        btn.dataset.topicId = t.id;
        btn.innerHTML = `
          <i class="${escapeHtml(t.icon || "fas fa-book")}"></i>
          <span class="nav-title">${escapeHtml(t.title || t.id)}</span>
          <span class="nav-actions" aria-label="Topic actions">
            <button class="rename" title="Rename"><i class="fas fa-pen"></i></button>
            <button class="delete" title="Delete"><i class="fas fa-trash"></i></button>
          </span>
        `;

        li.appendChild(btn);
        nav.appendChild(li);
      });

      highlightActive();
      document.getElementById("sidebar").classList.toggle("editing", state.editMode);
    }

    function highlightActive(){
      document.querySelectorAll(".nav-link").forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.topicId === state.currentTopic);
      });
    }

    function selectTopic(topicId){
      state.currentTopic = topicId;
      highlightActive();

      const topicKey = Object.keys(state.topics).find(k => state.topics[k].id === topicId);
      const t = topicKey ? state.topics[topicKey] : null;

      const area = document.getElementById("contentArea");
      if(!t){
        area.innerHTML = `
          <div class="empty">
            <i class="fas fa-triangle-exclamation"></i>
            <h3>Topic not found</h3>
            <p>Please select another topic.</p>
          </div>
        `;
        return;
      }

      area.innerHTML = t.content || `<div class="topic"><h2>${escapeHtml(t.title)}</h2><p>No content yet.</p></div>`;
      document.getElementById("pageTitle").textContent = t.title || "Preventive and Social Medicine";
      state.draftHtml = area.innerHTML;

      wireBlockSelection();
      if(state.editMode) makeEditable(true);
      else makeEditable(false);
    }

    function makeEditable(on){
      const area = document.getElementById("contentArea");
      area.querySelectorAll(".topic").forEach(el=>{
        el.classList.toggle("editable", on);
        el.setAttribute("contenteditable", on ? "true" : "false");
      });
    }

    function wireBlockSelection(){
      state.selectedBlock = null;
      const area = document.getElementById("contentArea");
      area.querySelectorAll(".selected-block").forEach(el=>el.classList.remove("selected-block"));

      area.addEventListener("click", (e)=>{
        if(!state.editMode) return;
        const block = e.target.closest("details, p, ul, .callout, img, h2, h3, h4");
        if(!block) return;
        area.querySelectorAll(".selected-block").forEach(el=>el.classList.remove("selected-block"));
        block.classList.add("selected-block");
        state.selectedBlock = block;
      }, { once: true });
    }

    function saveTopicEdits(){
      if(!state.currentTopic) return toast("No topic selected");
      const area = document.getElementById("contentArea");
      const html = area.innerHTML;

      const key = Object.keys(state.topics).find(k => state.topics[k].id === state.currentTopic);
      if(!key) return toast("Topic missing");
      state.topics[key].content = html;
      state.draftHtml = html;
      saveAll();
    }

    function cancelEdits(){
      const area = document.getElementById("contentArea");
      if(state.draftHtml != null) area.innerHTML = state.draftHtml;
      makeEditable(true);
      toast("Edits cancelled");
    }

    function previewEdits(){
      makeEditable(false);
      toast("Preview mode");
      setTimeout(()=>{ if(state.editMode) makeEditable(true); }, 1500);
    }

    function deleteSelectedBlock(){
      if(!state.selectedBlock) return toast("Select a block first");
      const el = state.selectedBlock;
      el.remove();
      state.selectedBlock = null;
      toast("Block removed");
    }

    function addBlock(){
      const area = document.getElementById("contentArea");
      const container = area.querySelector(".topic");
      if(!container) return;
      const details = document.createElement("details");
      details.open = true;
      details.innerHTML = `
        <summary>New subsection (click to rename)</summary>
        <div class="inside">
          <p>Write content here. Use simple language and bullets.</p>
          <ul>
            <li>Key point 1</li>
            <li>Key point 2</li>
          </ul>
        </div>
      `;
      container.appendChild(details);
      toast("Block added");
    }

    function openImageModal(){
      document.getElementById("imgUrl").value = "";
      document.getElementById("imgAlt").value = "";
      showModal("imageModal");
    }

    function insertImage(){
      const url = (document.getElementById("imgUrl").value || "").trim();
      const alt = (document.getElementById("imgAlt").value || "").trim() || "Educational image";
      if(!url) return toast("Add image URL");
      const area = document.getElementById("contentArea");
      const container = area.querySelector(".topic");
      if(!container) return;

      const img = document.createElement("img");
      img.src = url;
      img.alt = alt;
      container.appendChild(img);
      toast("Image inserted");
      hideModal("imageModal");
    }

    /***************
     * Topic management
     ***************/
    function renderManageList(){
      const list = document.getElementById("manageList");
      list.innerHTML = "";
      const keys = Object.keys(state.topics);

      keys.forEach(key=>{
        const t = state.topics[key];
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `
          <i class="${escapeHtml(t.icon || "fas fa-book")}"></i>
          <div class="name">${escapeHtml(t.title || t.id)}</div>
          <button class="mini" data-act="rename" data-key="${escapeHtml(key)}" title="Rename"><i class="fas fa-pen"></i></button>
          <button class="mini" data-act="delete" data-key="${escapeHtml(key)}" title="Delete"><i class="fas fa-trash"></i></button>
        `;
        list.appendChild(row);
      });
    }

    function addTopic(){
      const title = (document.getElementById("newTopicTitle").value || "").trim();
      const icon = (document.getElementById("newTopicIcon").value || "").trim() || "fas fa-book";
      if(!title) return toast("Enter a topic title");
      const id = slugify(title);
      if(Object.values(state.topics).some(t => t.id === id)) return toast("Topic already exists");

      state.topics[id] = {
        id,
        title,
        icon,
        content: `
          <div class="topic">
            <h2>${escapeHtml(title)}</h2>
            <p>Add content here. Use <b>details</b> sections for “Read more”.</p>
            <details open>
              <summary>Overview</summary>
              <div class="inside">
                <ul>
                  <li>Key message 1</li>
                  <li>Key message 2</li>
                </ul>
              </div>
            </details>
            <img src="" alt="${escapeHtml(title)} visual (add an image URL)">
          </div>
        `
      };

      document.getElementById("newTopicTitle").value = "";
      document.getElementById("newTopicIcon").value = "";
      renderNav();
      renderManageList();
      saveAll();
      selectTopic(id);
      toast("Topic added");
    }

    function renameTopicByKey(key){
      const t = state.topics[key];
      if(!t) return;
      const newTitle = prompt("Rename topic:", t.title || t.id);
      if(!newTitle) return;
      t.title = newTitle.trim();
      renderNav();
      renderManageList();
      saveAll();
      if(state.currentTopic === t.id) document.getElementById("pageTitle").textContent = t.title;
      toast("Renamed");
    }

    function deleteTopicByKey(key){
      const t = state.topics[key];
      if(!t) return;
      if(!confirm(`Delete topic "${t.title || t.id}"?`)) return;
      const deletingCurrent = state.currentTopic === t.id;
      delete state.topics[key];
      renderNav();
      renderManageList();
      saveAll();
      toast("Deleted");
      if(deletingCurrent){
        const first = Object.keys(state.topics)[0];
        if(first) selectTopic(state.topics[first].id);
        else document.getElementById("contentArea").innerHTML = `<div class="empty"><i class="fas fa-book"></i><h3>No topics</h3><p>Add a topic in edit mode.</p></div>`;
      }
    }

    /***************
     * Auth / UI
     ***************/
    const ADMIN_PASSWORD = "admin123";

    function authenticate(){
      const pw = document.getElementById("modalPassword").value || "";
      if(pw !== ADMIN_PASSWORD) return toast("Wrong password");
      state.isAuthenticated = true;
      state.editMode = true;
      localStorage.setItem(STORAGE_AUTH, "1");
      hideModal("loginModal");
      updateUI();
      toast("Edit mode enabled");
    }

    function logout(){
      state.isAuthenticated = false;
      state.editMode = false;
      localStorage.setItem(STORAGE_AUTH, "0");
      updateUI();
      toast("Edit mode disabled");
    }

    function updateUI(){
      document.getElementById("modePill").textContent = state.editMode ? "Edit" : "View";

      document.getElementById("loginBtn").style.display   = state.editMode ? "none" : "";
      document.getElementById("logoutBtn").style.display  = state.editMode ? "" : "none";
      document.getElementById("saveAllBtn").style.display = state.editMode ? "" : "none";
      document.getElementById("previewBtn").style.display = state.editMode ? "" : "none";
      document.getElementById("manageBtn").style.display  = state.editMode ? "" : "none";
      document.getElementById("exportBtn").style.display  = state.editMode ? "" : "none";
      document.getElementById("importBtn").style.display  = state.editMode ? "" : "none";

      document.getElementById("editControls").style.display = state.editMode ? "flex" : "none";
      document.getElementById("sidebar").classList.toggle("editing", state.editMode);

      if(state.currentTopic){
        if(state.editMode) makeEditable(true);
        else makeEditable(false);
      }
    }

    function showModal(id){
      const m = document.getElementById(id);
      m.classList.add("show");
      m.setAttribute("aria-hidden", "false");
    }
    function hideModal(id){
      const m = document.getElementById(id);
      m.classList.remove("show");
      m.setAttribute("aria-hidden", "true");
    }

    /***************
     * Import / Export
     ***************/
    function openExport(){
      const payload = {
        exportedAt: new Date().toISOString(),
        app: "PSM_WEB_APP",
        topics: state.topics
      };
      document.getElementById("exportText").value = JSON.stringify(payload, null, 2);
      showModal("exportModal");
    }

    async function copyExport(){
      const txt = document.getElementById("exportText").value;
      try{
        await navigator.clipboard.writeText(txt);
        toast("Copied");
      }catch(e){
        toast("Copy failed (select & copy manually)");
      }
    }

    function openImport(){
      document.getElementById("importText").value = "";
      showModal("importModal");
    }

    function doImport(){
      const raw = document.getElementById("importText").value;
      if(!raw.trim()) return toast("Paste JSON first");
      try{
        const parsed = JSON.parse(raw);
        if(!parsed || !parsed.topics) return toast("Invalid JSON format");
        state.topics = parsed.topics;
        renderNav();
        renderManageList();
        saveAll();
        const firstKey = Object.keys(state.topics)[0];
        if(firstKey) selectTopic(state.topics[firstKey].id);
        hideModal("importModal");
        toast("Imported");
      }catch(e){
        toast("Invalid JSON");
      }
    }

    /***************
     * Feedback (local only)
     ***************/
    function openFeedback(){ showModal("feedbackModal"); }
    function closeFeedback(){ hideModal("feedbackModal"); }

    function submitFeedback(){
      const name = (document.getElementById("fbName").value || "").trim();
      const role = document.getElementById("fbRole").value || "general";
      const msg  = (document.getElementById("fbText").value || "").trim();
      if(!msg) return toast("Please write a message");
      const list = JSON.parse(localStorage.getItem(STORAGE_FEEDBACK) || "[]");
      list.push({ ts: Date.now(), name, role, msg });
      localStorage.setItem(STORAGE_FEEDBACK, JSON.stringify(list));

      document.getElementById("fbName").value = "";
      document.getElementById("fbText").value = "";
      toast("Thanks! Saved locally.");
      closeFeedback();
    }

    /***************
     * Events
     ***************/
    function bindEvents(){
      // Sidebar toggle
      document.getElementById("menuToggle").addEventListener("click", () => {
        document.getElementById("sidebar").classList.toggle("active");
      });

      // Search filter
      document.getElementById("searchInput").addEventListener("input", (e) => {
        const term = (e.target.value || "").toLowerCase().trim();
        document.querySelectorAll("#navMenu .nav-item").forEach(li => {
          const txt = li.textContent.toLowerCase();
          li.style.display = txt.includes(term) ? "" : "none";
        });
      });

      // Nav click + edit actions
      document.getElementById("navMenu").addEventListener("click", (e) => {
        const navBtn = e.target.closest("button.nav-link");
        if(!navBtn) return;

        if(state.editMode){
          const renameBtn = e.target.closest("button.rename");
          const deleteBtn = e.target.closest("button.delete");
          if(renameBtn || deleteBtn){
            e.preventDefault();
            e.stopPropagation();
            const topicId = navBtn.dataset.topicId;
            const key = Object.keys(state.topics).find(k => state.topics[k].id === topicId);
            if(!key) return;
            if(renameBtn) renameTopicByKey(key);
            if(deleteBtn) deleteTopicByKey(key);
            return;
          }
        }

        const id = navBtn.dataset.topicId;
        if(id) selectTopic(id);

        if(window.innerWidth <= 980){
          document.getElementById("sidebar").classList.remove("active");
        }
      });

      // Auth
      document.getElementById("loginBtn").addEventListener("click", ()=>showModal("loginModal"));
      document.getElementById("modalCancelBtn").addEventListener("click", ()=>hideModal("loginModal"));
      document.getElementById("modalLoginBtn").addEventListener("click", authenticate);
      document.getElementById("modalPassword").addEventListener("keydown", (e)=>{ if(e.key==="Enter") authenticate(); });

      document.getElementById("logoutBtn").addEventListener("click", logout);

      // Editor controls
      document.getElementById("saveBtn").addEventListener("click", saveTopicEdits);
      document.getElementById("cancelBtn").addEventListener("click", cancelEdits);
      document.getElementById("previewBtn").addEventListener("click", previewEdits);
      document.getElementById("saveAllBtn").addEventListener("click", saveAll);
      document.getElementById("addBlockBtn").addEventListener("click", addBlock);
      document.getElementById("deleteBlockBtn").addEventListener("click", deleteSelectedBlock);

      document.getElementById("insertImageBtn").addEventListener("click", openImageModal);
      document.getElementById("insertImgBtn").addEventListener("click", insertImage);
      document.getElementById("closeImgBtn").addEventListener("click", ()=>hideModal("imageModal"));

      // Manage panel
      document.getElementById("manageBtn").addEventListener("click", ()=>{
        const p = document.getElementById("managePanel");
        const visible = p.style.display === "block";
        p.style.display = visible ? "none" : "block";
        renderManageList();
      });
      document.getElementById("closeManageBtn").addEventListener("click", ()=>document.getElementById("managePanel").style.display="none");
      document.getElementById("addTopicBtn").addEventListener("click", addTopic);

      document.getElementById("manageList").addEventListener("click", (e)=>{
        const btn = e.target.closest("button.mini");
        if(!btn) return;
        const key = btn.dataset.key;
        const act = btn.dataset.act;
        if(act === "rename") renameTopicByKey(key);
        if(act === "delete") deleteTopicByKey(key);
      });

      // Export/Import
      document.getElementById("exportBtn").addEventListener("click", openExport);
      document.getElementById("closeExportBtn").addEventListener("click", ()=>hideModal("exportModal"));
      document.getElementById("copyExportBtn").addEventListener("click", copyExport);

      document.getElementById("importBtn").addEventListener("click", openImport);
      document.getElementById("closeImportBtn").addEventListener("click", ()=>hideModal("importModal"));
      document.getElementById("doImportBtn").addEventListener("click", doImport);

      // Feedback
      document.getElementById("feedbackOpenBtn").addEventListener("click", openFeedback);
      document.getElementById("fbCloseBtn").addEventListener("click", closeFeedback);
      document.getElementById("fbSendBtn").addEventListener("click", submitFeedback);

      // Close modals when clicking outside box
      document.querySelectorAll(".modal").forEach(m=>{
        m.addEventListener("click", (e)=>{
          if(e.target === m) hideModal(m.id);
        });
      });

      // ESC to close modals / panels
      document.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          document.querySelectorAll(".modal.show").forEach(m=>hideModal(m.id));
          document.getElementById("managePanel").style.display = "none";
        }
      });

      // NEW: Home button
      document.getElementById("homeBtn").addEventListener("click", ()=>{
        if(state.topics.home){
          selectTopic("home");
        }else{
          const firstKey = Object.keys(state.topics)[0];
          if(firstKey) selectTopic(state.topics[firstKey].id);
        }
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }

    /***************
     * Init
     ***************/
    document.addEventListener("DOMContentLoaded", () => {
      loadData();
      renderNav();
      bindEvents();
      updateUI();

      // On first load always go to Home (if present)
      const startId = state.topics.home ? "home" : (Object.keys(state.topics)[0] && state.topics[Object.keys(state.topics)[0]].id);
      if(startId) selectTopic(startId);
    });
  </script>
</body>
</html>
